(()=>{"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(t,n,o){return(n=function(t){var n=function(t){if("object"!=e(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var o=n.call(t,"string");if("object"!=e(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==e(n)?n:n+""}(n))in t?Object.defineProperty(t,n,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[n]=o,t}var n;const o=t(t(t(t({},n=Symbol("timer"),null),"setup",(function(e){if(!e||!e.contentEditable)throw Error("setup failed: the target element does not exist or does not support the contentEditable attribute");if(!window.getSelection||!document.createRange)throw Error("setup failed: the browser doesn't support getSelection or createRange functions");e.contentEditable=!0,e.focus()})),"idle",(function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3;if("function"!=typeof e)throw new TypeError("idle failed: expected a function");if("number"!=typeof t||t<0)throw new TypeError("idle failed: expected a non-negative number for delay");return function(){for(var o=this,r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];this[n]&&(clearTimeout(this[n]),this[n]=null),this[n]=setTimeout((function(){e.apply(void 0,i),o[n]=null}),t)}.bind(this)})),"blur",(function(e){if("function"!=typeof e)throw new TypeError("Expected a function");return function(){this[n]&&(clearTimeout(this[n]),this[n]=null,e.apply(void 0,arguments))}.bind(this)}));var r,i,a=/^(https?:\/\/(([a-zA-Z0-9]+-?)+[a-zA-Z0-9]+\.)+(([a-zA-Z0-9]+-?)+[a-zA-Z0-9]+))(:\d+)?(\/.*)?(\?.*)?(#.*)?$/,c=/(https?:\/\/(([a-zA-Z0-9]+-?)+[a-zA-Z0-9]+\.)+(([a-zA-Z0-9]+-?)+[a-zA-Z0-9]+))(:\d+)?(\/.*)?(\?.*)?(#.*)?/,l=function(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return e.replace(/[&<>"']/g,(function(e){return t[e]}))},d=new Set(["block","block flex","block flow","block flow-root","block grid","list-item"]),s={handleText:function(e){var t="";if("string"!=typeof e)throw new Error("handleText failed: input is not a string");if(a.test(e))t+='<a href="'.concat(l(e),'">').concat(l(e),"</a>");else{for(var n,o=e;null!==(n=c.exec(o));){var r=n[0],i=o.slice(0,n.index),d=o.slice(n.index+r.length);t+=l(i),t+='<a href="'.concat(l(r),'">').concat(l(r),"</a>"),o=d}t+=l(o)}return t},handleAnchor:function(e){if(e&&e instanceof HTMLAnchorElement){var t=e.textContent;return a.test(t)?s.makePlainAnchor(e):e.textContent}throw TypeError("handle anchor error: the target is undefined, null or not a anchor")},makePlainAnchor:function(e){if(e&&e instanceof HTMLAnchorElement){if(e.href&&e.href.trim()&&e.textContent&&e.textContent.trim()){var t=document.createElement("a");return t.href=e.href,t.textContent=e.textContent,t}return console.warn("skip ".concat(e,", this anchor do not have content")),null}throw TypeError("make plain anchor error: the target is undefined, null or not a anchor")},compensateBR:function(e){return e&&(e instanceof HTMLBRElement||d.has(window.getComputedStyle(e).display))?"<br />":""}},f={saveSelection:function(e){if(e){if(window.getSelection){var t=window.getSelection().getRangeAt(0),n=t.cloneRange();n.selectNodeContents(e),n.setEnd(t.startContainer,t.startOffset);var o=n.toString().length;return{start:o,end:o+t.toString().length}}throw Error("save selection failed: the browser doesn't support getSelection function")}throw Error("save selection failed: the target element is null or undefined")},restoreSelection:function(e,t){if(!e||1!==e.nodeType&&3!==e.nodeType)throw Error("restore selection failed: target must be an html element or text node");if(!t||"number"!=typeof t.start||"number"!=typeof t.end||t.start>t.end)throw Error("restore selection failed: invalid position provided to restoreSelection.");if(!document.createRange||!window.getSelection)throw Error("restore selection failed: the current context does not support createRange or getSelection function.");var n=document.createRange();n.setStart(e,0),n.collapse(!0);for(var o,r=!1,i=!1,a=0,c=[e];!i&&(o=c.pop());)switch(o.nodeType){case 1:for(var l=o.childNodes.length-1;l>=0;l--)c.push(o.childNodes[l]);break;case 3:var d=a+o.length;!r&&t.start>=a&&t.start<=d&&(n.setStart(o,t.start-a),r=!0),r&&t.end>=a&&t.end<=d&&(n.setEnd(o,t.end-a),i=!0),a=d}if(r){var s=window.getSelection();s.removeAllRanges(),s.addRange(n)}else console.warn("restore selection failed: could not find the start or end position within the target node.")},extractTextAndAnchor:function(e,t,n){var o=this;if(!e||!e.nodeType)throw Error("extract text and anchors failed: the node is undefined, null or not a node");if(1!==e.nodeType&&3!==e.nodeType)throw Error("extract text and anchors failed: the node is not text or element");if(!n)throw TypeError("extract text and anchors failed: invalid nodeHandler, please check if it is an object with handleText, handleAnchor and makePlainAnchor methods.");if(!["handleText","handleAnchor","makePlainAnchor","compensateBR"].every((function(e){return"function"==typeof n[e]})))throw TypeError("extract text and anchors failed: invalid nodeHandler, please check if it is an object with handleText, handleAnchor and makePlainAnchor methods.");var r=n.handleText,i=n.handleAnchor,a=n.makePlainAnchor,c=n.compensateBR,l=3===e.nodeType?e.data:"";return e.childNodes.forEach((function(e){if(3===e.nodeType)l+=r(e.textContent);else if(1===e.nodeType)if("A"===e.tagName){var d=""===e.id?e.dataset.id:e.id;if(t&&t[d]){var s,f=i(e);f&&(f instanceof HTMLAnchorElement&&(f.href=f.textContent),l+=null!==(s=f.outerHTML)&&void 0!==s?s:f)}else{var u,h;l+=null!==(u=null===(h=a(e))||void 0===h?void 0:h.outerHTML)&&void 0!==u?u:""}}else l+=c(e)+o.extractTextAndAnchor(e,t,n)})),l},indexAnchors:function(e){var t={};if(e&&e instanceof HTMLElement){var n=e.querySelectorAll("a");if(n){var o=""===e.id?e.dataset.id:e.id;n.forEach((function(e,n){var r,i=null!==(r=e.dataset.id)&&void 0!==r?r:"".concat(o,"-anchor-").concat(n);e.href.replace(/\/+$/,"").toLowerCase()===e.textContent.toLowerCase()&&(e.dataset.id||e.setAttribute("data-id",i),t[[i]]=e.href)}))}return 0===Object.keys(t).length?null:t}throw TypeError("index anchors failed: the node is undefined, null or not a node")}};window.AutoLinkEditor=(i=!1,{init:function(e){if(e&&e.trim()){var t=document.getElementById(e);try{o.setup(t),t.onpaste=o.idle((function(e){i=!0,console.log("create anchors in onpaste"),t.innerHTML=f.extractTextAndAnchor(t,r,s),r=f.indexAnchors(t)}),0);var n=o.idle((function(e){if("Enter"===e.key)e.preventDefault();else if(i)i=!1;else{console.log("create anchors in keyup");var n=f.saveSelection(t);t.innerHTML=f.extractTextAndAnchor(t,r,s),r=f.indexAnchors(t),f.restoreSelection(t,n)}}),1e3);t.onkeyup=n,t.onfocus=function(e){r=f.indexAnchors(t)}}catch(e){console.error(e)}}else console.warn("init failed: id cannot be undefined, null, empty or white space")}})})();